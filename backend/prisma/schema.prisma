// Prisma schema for UML Generator

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  projects     Project[]

  @@map("users")
}

enum ProjectStatus {
  PENDING
  DONE
  ERROR
}

model Project {
  id           String        @id @default(uuid())
  userId       String?
  title        String
  prompt       String        @db.Text
  status       ProjectStatus @default(PENDING)
  errorMessage String?       @db.Text
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  diagrams     Diagram[]

  @@index([userId])
  @@index([createdAt])
  @@map("projects")
}

enum DiagramType {
  CLASS
  SEQUENCE
  ACTIVITY
  USE_CASE
  STATE
  COMPONENT
}

model Diagram {
  id                String    @id @default(uuid())
  projectId         String
  type              DiagramType
  title             String
  currentVersionId  String?   @unique
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  versions          DiagramVersion[]
  currentVersion    DiagramVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([type])
  @@map("diagrams")
}

model DiagramVersion {
  id            String   @id @default(uuid())
  diagramId     String
  versionNumber Int
  dsl           String   @db.Text
  imageUrl      String?
  createdAt     DateTime @default(now())
  
  diagram       Diagram  @relation(fields: [diagramId], references: [id], onDelete: Cascade)
  currentFor    Diagram? @relation("CurrentVersion")

  @@unique([diagramId, versionNumber])
  @@index([diagramId])
  @@map("diagram_versions")
}
